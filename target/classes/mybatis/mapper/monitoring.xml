<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="monitoring">
		<!-- 알람이력 조회 -->
	<select id="getAlarmList" parameterType="Monitoring" resultType="Monitoring">
SELECT
    aa.alarm_address AS alarm_address,
    aa.comment AS comment,
    aa.regtime AS occur_time,
    aa.clear_time
FROM (
    SELECT
        *,
        CASE 
            WHEN LEAD(a_value) OVER (PARTITION BY alarm_address ORDER BY regtime) = 0
            THEN LEAD(regtime) OVER (PARTITION BY alarm_address ORDER BY regtime)
            ELSE NULL
        END AS clear_time,
        LAG(a_value) OVER (PARTITION BY alarm_address ORDER BY regtime) AS prev_value
    FROM tb_alarmlist
) AS aa
WHERE 1=1
<if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
AND DATE(regtime) between #{startDate} and #{endDate}
</if>
<if test="machine_name != null and machine_name != ''">
AND alarm_address LIKE CONCAT('%', #{machine_name}, '%')
</if>
    AND aa.a_value = 1
    AND (aa.prev_value IS NULL OR aa.prev_value = 0)
ORDER BY aa.regtime DESC;
	</select>
		<select id="getTempList" parameterType="Monitoring" resultType="Monitoring">
SELECT * FROM tb_trend_temp AS tt
LEFT JOIN tb_trend_memo AS tm
ON LEFT(tt.date, 16) = tm.date
WHERE 1=1
<if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
AND tt.date between #{startDate} and #{endDate}
</if>
ORDER BY tt.date ASC;
	</select>
	<!-- 알람 랭킹 -->
		<select id="getAlarmRankingList" parameterType="Monitoring" resultType="Monitoring">
SELECT
    aa.alarm_address AS alarm_address,
    aa.comment AS comment,
    aa.regtime AS occur_time,
    aa.clear_time,
    COUNT(aa.alarm_address) AS alarm_count
FROM (
    SELECT
        *,
        CASE 
            WHEN LEAD(a_value) OVER (PARTITION BY alarm_address ORDER BY regtime) = 0
            THEN LEAD(regtime) OVER (PARTITION BY alarm_address ORDER BY regtime)
            ELSE NULL
        END AS clear_time
    FROM tb_alarmlist
) AS aa
WHERE 1=1
<if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
AND DATE(regtime) between #{startDate} and #{endDate}
</if>
<if test="machine_name != null and machine_name != ''">
AND alarm_address LIKE CONCAT('%', #{machine_name}, '%')
</if>
    AND aa.a_value = 1
    AND aa.clear_time IS NOT null
    GROUP BY aa.alarm_address
ORDER BY alarm_count DESC;
	</select>
	<!-- 알람현황 -->
		<select id="getAlarm1" parameterType="Monitoring" resultType="Monitoring">
SELECT *
FROM v_alarm_status
WHERE 1=1
AND info_hogi = #{machine_name}
AND alarm_hogi = #{machine_name}
<if test="machine_name != null and machine_name.contains('BCF')">
LIMIT 50
</if>
	</select>
	
	    <!-- LOT 보고서 조회 -->
	<select id="getLotList" parameterType="productManage" resultType="productManage">
	SELECT l.lotno AS lot_no, l.lotno_date, l.pattern, l.fac_no, 
	lt.bcf_up, lt.bcf_chim, lt.bcf_diff, lt.bcf_gang, lt.bcf_quen, lt.bcf_drain FROM tb_lot AS l
	INNER JOIN tb_lot_tracking AS lt
	ON l.lotno = lt.lotno
	<where>
		<if test="fac_no != '' and fac_no != null">
		AND l.fac_no = #{fac_no}
		</if>
		<if test="lotno_date != '' and lotno_date != null">
		AND lotno_date LIKE CONCAT(#{lotno_date}, '%')
		</if>
	</where>
	</select>
	<!-- 트렌드 메모 추가 -->
	<insert id="trendMemoInsert" parameterType="productManage">
	INSERT INTO tb_trend_memo
	(date, user_code, writer, memo, note)
	VALUES(#{date}, #{user_code}, #{writer}, #{memo}, #{note})
	</insert>
</mapper>