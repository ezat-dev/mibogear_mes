<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="productManage">
    
    
    <!-- LOT 보고서 조회 -->
	<select id="getLotList" parameterType="productManage" resultType="productManage">
	SELECT l.regtime, l.lotno AS lot_no, l.lotno_date, l.pattern, l.fac_no, 
	lt.bcf_up, lt.bcf_chim, lt.bcf_diff, lt.bcf_gang, lt.bcf_quen, lt.bcf_drain, lt.end_time
	FROM tb_lot AS l
	INNER JOIN tb_lot_tracking AS lt
	ON l.lotno = lt.lotno
	WHERE l.fac_no = #{fac_no_save}
	</select>
	
	<!-- LOT 보고서 조회(리포트)-->
	<select id="getLotListReport" parameterType="productManage" resultType="productManage">
	SELECT l.regtime, l.lotno AS lot_no, l.lotno_date, l.pattern, l.fac_no, 
	lt.bcf_up, lt.bcf_chim, lt.bcf_diff, lt.bcf_gang, lt.bcf_quen, lt.bcf_drain,
	CAST(p.ptrn_hogi AS CHAR) AS ptrn_hogi, 
    CAST(p.ptrn_d1000 AS CHAR) AS ptrn_d1000, 
    CAST(p.ptrn_d901 AS CHAR) AS ptrn_d901, 
    CAST(p.ptrn_d911 AS CHAR) AS ptrn_d911, 
    CAST(p.ptrn_d921 AS CHAR) AS ptrn_d921, 
    CAST(p.ptrn_d904 AS CHAR) AS ptrn_d904, 
    CAST(p.ptrn_d914 AS CHAR) AS ptrn_d914, 
    CAST(p.ptrn_d924 AS CHAR) AS ptrn_d924,
    CAST(p.ptrn_d905 AS CHAR) AS ptrn_d905, 
    CAST(p.ptrn_d915 AS CHAR) AS ptrn_d915, 
    CAST(p.ptrn_d925 AS CHAR) AS ptrn_d925, 
    CAST(p.ptrn_d906 AS CHAR) AS ptrn_d906, 
    CAST(p.ptrn_d916 AS CHAR) AS ptrn_d916, 
    CAST(p.ptrn_d926 AS CHAR) AS ptrn_d926, 
    CAST(p.ptrn_d908 AS CHAR) AS ptrn_d908, 
    CAST(p.ptrn_d918 AS CHAR) AS ptrn_d918,
    CAST(p.ptrn_d909 AS CHAR) AS ptrn_d909, 
    CAST(p.ptrn_d919 AS CHAR) AS ptrn_d919
	FROM tb_lot AS l
	INNER JOIN tb_lot_tracking AS lt
	ON l.lotno = #{lot_no}
	LEFT JOIN tb_pattern as p
	ON l.pattern = CAST(p.ptrn_d1000 AS char)
	WHERE lt.lotno = #{lot_no}
	</select>
	
	    <!-- 종합생산현황 페이지 lot 조회 -->
	<select id="integrationLotList" parameterType="productManage" resultType="productManage">
	SELECT *, lt.end_time FROM tb_lot AS l
	INNER JOIN tb_lot_tracking AS lt
	ON l.lotno = lt.lotno
	ORDER BY l.regtime DESC LIMIT 7
	</select>
	
	<!-- 종합생산현황 페이지 온도 조회 -->
    	<select id="integrationGetTemp" parameterType="monitoring" resultType="monitoring">
	SELECT * FROM tb_trend_temp AS tt
LEFT JOIN tb_trend_memo AS tm
ON LEFT(tt.date, 16) = tm.date
ORDER BY tt.date DESC LIMIT 1;
	</select>
	
	<!-- 작업일보 조회 -->
	<select id="workDailyList" parameterType="productManage" resultType="productManage">
	SELECT 
	    DATE(s.first_time) AS regtime,
	    s.total_count AS count,
	    s.first_time AS first_lot_time,
	    l2.lotno AS first_lot,
	    s.last_time AS last_lot_time,
	    l3.lotno AS last_lot
	FROM (
	    SELECT 
	        DATE(regtime) AS d,
	        COUNT(*) AS total_count,
	        MIN(regtime) AS first_time,
	        MAX(regtime) AS last_time
	    FROM tb_lot
	    GROUP BY DATE(regtime)
	) AS s
	JOIN tb_lot AS l2 ON s.first_time = l2.regtime
	JOIN tb_lot AS l3 ON s.last_time = l3.regtime
	<where>
		<if test="date != null and date != ''">
		AND d LIKE CONCAT(#{date}, '%')
		</if>
	</where>
	ORDER BY regtime ASC
	</select>
	
	<!-- 작업일보 리포트 생성 -->
		<select id="workDailyListReport" parameterType="productManage" resultType="productManage">
SELECT l.lotno, l.regtime, lt.end_time, DATE(l.regtime) AS date
FROM tb_lot AS l
INNER JOIN tb_lot_tracking AS lt ON l.lotno = lt.lotno
WHERE l.regtime LIKE CONCAT(#{regtime}, '%')
	</select>
</mapper>